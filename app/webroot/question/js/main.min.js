(function(a,h){"function"===typeof define&&define.amd?define("jquery mooFileUploader mooBehavior mooAlert mooPhrase mooAjax mooGlobal tinyMCE mooTooltip".split(" "),h):"object"===typeof exports?module.exports=h(require("jquery")):a.mooQuestion=h()})(this,function(a,h,v,w,g,x,k,f,m){var y=function(b){a("#tags").tokenize({datas:mooConfig.url.base+"/question/question_suggest/tag"});0<a("#attachments_upload").length&&(extension=a("#attachments_upload").data("extension").split(","),new h.fineUploader({element:a("#attachments_upload")[0],
text:{uploadButton:'<div class="upload-section"><i class="material-icons">insert_drive_file</i>'+g.__("upload_button_text")+"</div>"},validation:{allowedExtensions:extension,sizeLimit:mooConfig.sizeLimit},request:{endpoint:mooConfig.url.base+"/question/question_upload/attachments/Question"},callbacks:{onError:k.errorHandler,onComplete:function(b,d,e){d=a("#attachments").val();if(e.attachment_id)f.activeEditor.insertContent('<p><a href="'+mooConfig.url.base+"/question/question_attachments/download/"+
e.attachment_id+'" class="attached-file">'+e.original_filename+"</a></p><br>"),""==d?a("#attachments").val(e.attachment_id):a("#attachments").val(d+","+e.attachment_id);else if(b||e.thumb)a("#photo_ids").val(a("#photo_ids").val()+","+e.photo_id),f.activeEditor.insertContent('<p align="center"><a href="'+e.large+'" class="attached-image"><img src="'+e.thumb+'"></a></p><br>')}}}));a(".attach_remove").click(function(){var b=a(this);b.parent().fadeOut();var d=a("#attachments").val().split(",");b=d.indexOf(b.attr("data-id"));
d.splice(b,1);a("#attachments").val(d.join(","));return!1});text_upload_button=""!=g.__("upload_button_text_photo")?'<div class="upload-section"><i class="material-icons">photo_camera</i>'+g.__("upload_button_text_photo")+"</div>":'<div class="upload-section"></div>';new h.fineUploader({element:a("#question_thumnail")[0],multiple:!1,text:{uploadButton:text_upload_button},validation:{allowedExtensions:["jpg","jpeg","gif","png"],sizeLimit:mooConfig.sizeLimit},request:{endpoint:mooConfig.url.base+"/questions/upload_avatar"},
callbacks:{onError:k.errorHandler,onComplete:function(b,d,e){a("#question_thumnail_preview > img").attr("src",e.thumb);a("#question_thumnail_preview > img").show();a("#thumbnail").val(e.file)}}});a("#question_button").click(function(){button=a(this);button.addClass("disabled");null!==f.activeEditor&&a("#description").val(f.activeEditor.getContent());x.post({url:mooConfig.url.base+"/questions/save",data:jQuery("#createForm").serialize()},function(c){c=a.parseJSON(c);1==c.result?window.location=mooConfig.isApp?
c.href+"?app_no_tab=1":""!=b?b:mooConfig.url.base+"/questions":(button.removeClass("disabled"),a(".error-message").show(),a(".error-message").html(c.message))});return!1});l()},l=function(){a(".deleteQuestion").unbind("click");a(".deleteQuestion").click(function(){var b=a(this).data();b=mooConfig.isApp?mooConfig.url.base+"/questions/delete/"+b.id+"?app_no_tab=1":mooConfig.url.base+"/questions/delete/"+b.id;w.confirm(g.__("delete_question_confirm"),b)})},z=function(b){a("#category").change(function(b){a("#question_form_search").submit()})},
n=function(b,c,d,e){b=a(b);a.ajax({type:"POST",dataType:"json",url:mooConfig.url.base+"/questions/ajax_vote",data:{type:c,id:d,up:e},success:function(a){a.status&&(block=b.parents(".vote-block"),b.hasClass("active")?b.removeClass("active"):(block.find(".img-circle").not(".mark_answer").removeClass("active"),b.addClass("active")),block.find(".vote-count").html(a.vote_count))}})},F=function(){a('[data-toggle="popover"]').popover();0<a("#attachments_upload").length&&(extension=a("#attachments_upload").data("extension").split(","),
new h.fineUploader({element:a("#attachments_upload")[0],text:{uploadButton:'<div class="upload-section"><i class="material-icons">insert_drive_file</i>'+g.__("upload_button_text")+"</div>"},validation:{allowedExtensions:extension,sizeLimit:mooConfig.sizeLimit},request:{endpoint:mooConfig.url.base+"/question/question_upload/attachments/Answer"},callbacks:{onError:k.errorHandler,onComplete:function(b,c,d){c=a("#attachments").val();if(d.attachment_id)f.get("content").insertContent('<p><a href="'+mooConfig.url.base+
"/question/question_attachments/download/"+d.attachment_id+'" class="attached-file">'+d.original_filename+"</a></p><br>"),""==c?a("#attachments").val(d.attachment_id):a("#attachments").val(c+","+d.attachment_id);else if(b||d.thumb)a("#photo_ids").val(a("#photo_ids").val()+","+d.photo_id),f.get("content").insertContent('<p align="center"><a href="'+d.large+'" class="attached-image"><img src="'+d.thumb+'"></a></p><br>')}}}));a("#form_reply").submit(function(b){if(null!=f.get("content")){if(""!=f.get("content").getContent({format:"text"}).trim()||
-1!=f.get("content").getContent().search("img"))return!0}else if(""!=a("#content").val().trim())return!0;b.preventDefault()});l();a(".question_vote_up").click(function(){n(this,a(this).data("type"),a(this).data("id"),1)});a(".question_vote_down").click(function(){n(this,a(this).data("type"),a(this).data("id"),0)});a(".question_add_favorite").click(function(){A(a(this).data("id"))});a(".question_mark_best_answer").click(function(){B(this,a(this).data("id"))});a(".question_edit_answer").click(function(){C(a(this).data("id"))});
a(".question_delete_answer").click(function(){D(a(this).data("id"))});a(".question_more_comment").click(function(){p(this,a(this).data("type"),a(this).data("id"))});a(".question_comment_action").click(function(){E(this,a(this).data("type"),a(this).data("id"))});a(".question_show_comment").click(function(){var b=a(this);b.hide();b.parent().find(".comments-form_content").show();b.parent().find("textarea").autogrow()});a("body").on("click",".question_edit_comment",function(b){q(a(this).data("id"),this)});
a("body").on("click",".question_delete_comment",function(b){r(a(this).data("id"))});a("body").on("click",".question_cancel_edit_comment",function(b){t(this,a(this).data("id"))});a("body").on("click",".question_save_edit_comment",function(b){u(this,a(this).data("id"))})},E=function(b,c,d){b=a(b);text=b.parent().parent().find("textarea");""!=a.trim(text.val())&&(b.addClass("disabled"),a.ajax({type:"POST",url:mooConfig.url.base+"/questions/ajax_comment",data:{type:c,id:d,message:a.trim(text.val())},
success:function(c){b.removeClass("disabled");text.val("");b.parents(".comments-wrapper").find(".comment_list").append(a(c));m.init()}}))},q=function(b,c){a(c).parent().hide();a(c).parents(".comment-content").find(".cm-wrap").hide();a("#comment_edit_"+b).show();a("#comment_edit_"+b).find("textarea").autogrow();a("#comment_edit_"+b).find("textarea").val(a.trim(a(c).parents(".comment-content").find(".cm-wrap").html()))},t=function(b,c){a("#comment_edit_"+c).hide();a("#comment_edit_"+c).find("textarea").val("");
a(b).parents(".comment-content").find(".cm-wrap").show();a(b).parents(".comment-content").find(".comment-edit").show()},r=function(b){a.fn.SimpleModal({btn_ok:g.__("btn_ok"),btn_cancel:g.__("btn_cancel"),callback:function(){a.post(mooConfig.url.base+"/questions/ajax_remove_comment",{id:b},function(){a("#comment_"+b).fadeOut("normal",function(){a("#comment_"+b).remove()})})},title:g.__("confirm_title"),contents:g.__("please_confirm_remove_this_comment"),model:"confirm",hideFooter:!1,closeButton:!1}).showModal()},
p=function(b,c,d){a(b).html("&nbsp");a(b).parent().spin("small");a.ajax({type:"POST",url:mooConfig.url.base+"/questions/ajax_load_comment",data:{type:c,id:d},success:function(c){a(b).parent().hide();a(b).parents(".comments-wrapper").find(".comments-form").show();a(c).children().each(function(c){a(b).parents(".comments-wrapper").find(".comment_list").append(a(this))});m.init()}})},u=function(b,c){b=a(b);text=b.parent().parent().find("textarea");""!=a.trim(text.val())&&(b.addClass("disabled"),a.ajax({type:"POST",
dataType:"json",url:mooConfig.url.base+"/questions/ajax_edit_comment",data:{id:c,message:a.trim(text.val())},success:function(d){a("#comment_edit_"+c).hide();b.removeClass("disabled");b.parents(".comment-content").find(".cm-wrap").html(a.trim(text.val()));b.parents(".comment-content").find(".cm-wrap").show();a(b).parents(".comment-content").find(".comment-edit").show();text.val("");d.status&&a("#comment_history_"+c).show()}}))},B=function(b,c){a.ajax({type:"POST",dataType:"json",url:mooConfig.url.base+
"/questions/ajax_mark_best_answer",data:{id:c},success:function(c){c.status&&(a(".mark_answer").removeClass("active"),c.active&&a(b).addClass("active"))}})},D=function(b){a.fn.SimpleModal({btn_ok:g.__("btn_ok"),btn_cancel:g.__("btn_cancel"),callback:function(){a.ajax({type:"POST",dataType:"json",url:mooConfig.url.base+"/questions/ajax_delete_answer",data:{id:b},success:function(c){a("#portlet-config").modal("hide");c.status&&(a("#answer_"+b).remove(),a("#count_answer").html(parseInt(a("#count_answer").html())-
1))}})},title:g.__("confirm_title"),contents:g.__("confirm_delete_answer"),model:"confirm",hideFooter:!1,closeButton:!1}).showModal()},C=function(b){a("#edit_answer").modal("show");a("#edit_answer_button").removeClass("disabled");null!=f.get("content_edit_answer")?f.get("content_edit_answer").setContent(a("#content_answer_"+b).html()):a("#content_edit_answer").val(a("#content_answer_"+b).html());a("#attachments_edit").val("");0<a("#edit_attachments_upload").length&&(extension=a("#edit_attachments_upload").data("extension").split(","),
new h.fineUploader({element:a("#edit_attachments_upload")[0],text:{uploadButton:'<div class="upload-section"><i class="material-icons">insert_drive_file</i>'+g.__("upload_button_text")+"</div>"},validation:{allowedExtensions:extension,sizeLimit:mooConfig.sizeLimit},request:{endpoint:mooConfig.url.base+"/question/question_upload/attachments/Answer"},callbacks:{onError:k.errorHandler,onComplete:function(b,d,e){d=a("#attachments_edit").val();if(e.attachment_id)f.get("content_edit_answer").insertContent('<p><a href="'+
mooConfig.url.base+"/question/question_attachments/download/"+e.attachment_id+'" class="attached-file">'+e.original_filename+"</a></p><br>"),""==d?a("#attachments_edit").val(e.attachment_id):a("#attachments_edit").val(d+","+e.attachment_id);else if(b||e.thumb)a("#edits_photo_ids").val(a("#edits_photo_ids").val()+","+e.photo_id),f.get("content_edit_answer").insertContent('<p align="center"><a href="'+e.large+'" class="attached-image"><img src="'+e.thumb+'"></a></p><br>')}}}));a("#edit_answer_button").unbind("click");
a("#edit_answer_button").click(function(c){if(null!=f.get("content_edit_answer")){if(""==f.get("content_edit_answer").getContent({format:"text"}).trim()&&-1==f.get("content_edit_answer").getContent().search("img"))return}else if(""==a("#content_edit_answer").val().trim())return;a("#edit_answer_button").addClass("disabled");var d="";d=null!=f.get("content_edit_answer")?f.get("content_edit_answer").getContent():a("#content_edit_answer");a.ajax({type:"POST",dataType:"json",url:mooConfig.url.base+"/questions/ajax_edit_answer",
data:{id:b,content:d,attachments:a("#attachments_edit").val(),photo_ids:a("#edits_photo_ids").val()},success:function(c){a("#edit_answer").modal("hide");c.status&&(a("#history_answer_"+b).show(),a("#content_answer_"+b).html(d))}})})},A=function(b){a.ajax({type:"POST",dataType:"json",url:mooConfig.url.base+"/questions/ajax_favorite",data:{id:b},success:function(b){b.status&&(a(".favorite_t").removeClass("star_active"),a("#favorite_count").html(b.count),b.favorite&&a(".favorite_t").addClass("star_active"))}})};
return{initCreateQuestion:function(a){y(a)},initBrowseQuestion:function(a){z(a)},initViewQuestion:function(){F()},initListingQuestion:function(){l();v.initMoreResults()},editComment:function(a,c){q(a,c)},cancelEditComment:function(a,c){t(a,c)},deleteComment:function(a){r(a)},showMoreComment:function(a,c,d){p(a,c,d)},saveEditComment:function(a,c){u(a,c)},editAnswerApp:function(b){a("#attachments_edit").val("");0<a("#edit_attachments_upload").length&&(extension=a("#edit_attachments_upload").data("extension").split(","),
new h.fineUploader({element:a("#edit_attachments_upload")[0],text:{uploadButton:'<div class="upload-section"><i class="material-icons">insert_drive_file</i>'+g.__("upload_button_text")+"</div>"},validation:{allowedExtensions:extension,sizeLimit:mooConfig.sizeLimit},request:{endpoint:mooConfig.url.base+"/question/question_upload/attachments/Answer"},callbacks:{onError:k.errorHandler,onComplete:function(b,d,e){d=a("#attachments_edit").val();if(e.attachment_id)f.get("content_edit_answer").insertContent('<p><a href="'+
mooConfig.url.base+"/question/question_attachments/download/"+e.attachment_id+'" class="attached-file">'+e.original_filename+"</a></p><br>"),""==d?a("#attachments_edit").val(e.attachment_id):a("#attachments_edit").val(d+","+e.attachment_id);else if(b||e.thumb)a("#edits_photo_ids").val(a("#edits_photo_ids").val()+","+e.photo_id),f.get("content_edit_answer").insertContent('<p align="center"><a href="'+e.large+'" class="attached-image"><img src="'+e.thumb+'"></a></p><br>')}}}));a("#edit_answer_button").unbind("click");
a("#edit_answer_button").click(function(c){if(null!=f.get("content_edit_answer")){if(""==f.get("content_edit_answer").getContent({format:"text"}).trim()&&-1==f.get("content_edit_answer").getContent().search("img"))return}else if(""==a("#content_edit_answer").val().trim())return;a("#edit_answer_button").addClass("disabled");c="";c=null!=f.get("content_edit_answer")?f.get("content_edit_answer").getContent():a("#content_edit_answer");a.ajax({type:"POST",dataType:"json",url:mooConfig.url.base+"/questions/ajax_edit_answer",
data:{id:b,content:c,attachments:a("#attachments_edit").val(),photo_ids:a("#edits_photo_ids").val()},success:function(b){a("#edit_answer").modal("hide");b.status&&window.mobileAction.backAndRefesh({})}})})}}});