!function(e,t){"function"==typeof define&&define.amd?define(["jquery","mooPhrase","mooBehavior","mooMention","mooEmoji","mooFileUploader","mooUser","mooButton","mooGlobal","mooResponsive","mooAttach","mooComment","mooLike","mooTooltip","autogrow","spinner"],t):"object"==typeof exports?module.exports=t(require("jquery")):e.mooActivities=t()}(this,function(e,t,i,o,a,n,r,s,c,l,m,d,v,_){var u={},g=function(i,o){e.fn.SimpleModal({btn_ok:t.__("confirm"),btn_cancel:t.__("cancel"),callback:function(){e.post(mooConfig.url.base+"/activities/ajax_remove_tags",{item_id:i,item_type:o},function(){window.location.reload()})},title:t.__("remove_tags"),contents:t.__("remove_tags_contents"),model:"confirm",hideFooter:!1,closeButton:!1}).showModal()},f=function(t){e("#comments_"+t+" .hidden").fadeIn(),e("#comments_"+t+" .hidden").attr("class",""),e("#all_comments_"+t).hide()},p=function(){e(".removeActivity").unbind("click"),e(".removeActivity").click(function(){var i,o=e(this).data();i=o.activityId,e.fn.SimpleModal({btn_ok:t.__("ok"),btn_cancel:t.__("cancel"),callback:function(){e.post(mooConfig.url.base+"/activities/ajax_remove",{id:i},function(){e("#activity_"+i).fadeOut("normal",function(){e("#activity_"+i).remove(),e("body").trigger("afterRemoveActivityCallback",[])})})},title:t.__("please_confirm"),contents:t.__("please_confirm_remove_this_activity"),model:"confirm",hideFooter:!1,closeButton:!1}).showModal()})},h=[],y=function(t){0==e("#activity_edit_"+t).length&&e.post(mooConfig.url.base+"/activities/ajax_loadActivityEdit/"+t,function(i){e("#activity_feed_content_text_"+t+" .comment_message").hide(),e(i).insertAfter(e("#activity_feed_content_text_"+t+" .comment_message")),h.push(t),C(),o.init(e(i).find("textarea").attr("id"),"edit_activity"),a.init(e(i).find("textarea").attr("id")),e("body").trigger("afterLoadFormEditActivityCallback",[])})},b=function(t){e("#message_edit_"+t).siblings(".textoverlay")&&e("#message_edit_"+t).destroyOverlayInstance(e("#message_edit_"+t)),e("#activity_feed_content_text_"+t+" .comment_message").show(),e("#activity_edit_"+t).remove();var i=e.inArray(t,h);h.splice(i,1),e("body").trigger("afterCancelFormEditActivityCallback",[])},w=function(t){var i;""!=e.trim(e("#message_edit_"+t).val())&&(i=0!=e("#message_edit_"+t+"_hidden").length?e("#message_edit_"+t+"_hidden").val():e("#message_edit_"+t).val(),e.post(mooConfig.url.base+"/activities/ajax_editActivity/"+t,{message:i},function(i){e("#message_edit_"+t).siblings(".textoverlay")&&e("#message_edit_"+t).destroyOverlayInstance(e("#message_edit_"+t)),e("#activity_feed_content_text_"+t+" .comment_message").html(e(i).html()),e("#history_activity_"+t).show(),b(t)}))},k=function(t,o){"1"===mooConfig.comment_sort_style?e("#newComment_"+t).before(o):e("#newComment_"+t).after(o),e(".slide").slideDown(),e("#commentButton_"+t+" a").removeClass("disabled"),e("#commentButton_"+t+" a i").remove(),e("#commentForm_"+t).val(""),e(".commentBox").css("height","27px"),e("#comment_preview_image_"+t).html(""),e("#comment_image_"+t).val(""),e("#comment_button_attach_"+t).show(),i.registerImageComment(),C()},C=function(a){e("textarea:not(.no-grow)").autogrow(),void 0!==typeof u&&(u=a),e(".removeTags").unbind("click"),e(".removeTags").click(function(){var t=e(this).data();g(t.activityId,t.activityItemType)}),e(".editActivity").unbind("click"),e(".editActivity").click(function(){var t=e(this).data();y(t.activityId)}),p(),d.initEditActivityComment(),d.initRemoveActivityComment(),d.initRemoveItemComment(),e("body").off("click.activity","a.admin-or-owner-confirm-delete-photo-comment").on("click.activity","a.admin-or-owner-confirm-delete-photo-comment",function(){var i,o=e(this).data();void 0!==typeof o.commentId&&(i=o.commentId,e.fn.SimpleModal({btn_ok:t.__("ok"),btn_cancel:t.__("cancel"),callback:function(){e.post(mooConfig.url.base+"/comments/ajax_remove",{id:i},function(){e("#photo_comment_"+i).fadeOut("normal",function(){e("#photo_comment_"+i).remove()})})},title:t.__("please_confirm"),contents:t.__("please_confirm_remove_this_activity"),model:"confirm",hideFooter:!1,closeButton:!1}).showModal())}),e("body").off("click.activity","a.viewer-submit-comment").on("click.activity","a.viewer-submit-comment",function(){var t=e(this).data();void 0!==typeof t.activityId&&function(t){if(""!=e.trim(e("#commentForm_"+t).val())||""!=e("#comment_image_"+t).val()){e("#commentButton_"+t+" a").addClass("disabled"),e("#commentButton_"+t+" a").prepend('<i class="icon-refresh icon-spin"></i>');var i=e("#commentForm_"+t).siblings("input.messageHidden").length>0?e("#commentForm_"+t).siblings("input.messageHidden").val():e("#commentForm_"+t).val();e.post(mooConfig.url.base+"/activities/ajax_comment",{activity_id:t,thumbnail:e("#comment_image_"+t).val(),comment:i},function(i){if(""!=i){k(t,i);var a=e("#commentForm_"+t);o.resetMention(a),_.init()}})}}(t.activityId)}),e("body").off("click.activity","a.viewer-submit-item-comment").on("click.activity","a.viewer-submit-item-comment",function(){var t=e(this).data();void 0!==typeof t.itemType&&void 0!==typeof t.activityItemId&&void 0!==typeof t.activityId&&function(t,i,a){if(""!=e.trim(e("#commentForm_"+a).val())||""!=e("#comment_image_"+a).val()){e("#commentButton_"+a+" a").prepend('<i class="icon-refresh icon-spin"></i>'),e("#commentButton_"+a+" a").addClass("disabled");var n="";n=e("#commentForm_"+a).siblings(".messageHidden").length>0?e("#commentForm_"+a).siblings(".messageHidden").val():e("#commentForm_"+a).val(),e.post(mooConfig.url.base+"/comments/ajax_share",{type:t,target_id:i,thumbnail:e("#comment_image_"+a).val(),message:n,activity:1},function(t){if(""!=t){k(a,t);var i=e("#commentForm_"+a);o.resetMention(i),_.init()}})}}(t.itemType,t.activityItemId,t.activityId)}),e("body").off("click.activity","a.change-activity-privacy").on("click.activity","a.change-activity-privacy",function(){var t,i,o,a=e(this).data();void 0!==typeof a.activityId&&void 0!==typeof a.privacy&&(t=e(this),i=a.activityId,o=a.privacy,e.post(mooConfig.url.base+"/activities/ajax_changeActivityPrivacy/",{activityId:i,privacy:o},function(e){if(""!=e){e=JSON.parse(e);var o=t.parents(".dropdown");o.find("a#permission_"+i).attr("original-title",e.text),o.find("a#permission_"+i+" i").html(e.icon),o.find(".dropdown-menu li a").removeClass("n52"),t.addClass("n52")}}))}),d.initShowCommentForm(),v.initLikeActivity(),d.initRemoveItemComment(),d.initEditItemComment(),d.initShowCommentBtn(),e(".showAllComments").unbind("click"),e(".showAllComments").on("click",function(){var t=e(this).data();f(t.id)}),i.initMoreResults(),i.initFeedForm()};var I=function(t){var i=e("#message").val();if(t=function(e){if(result=e.match(/\b([\d\w\.\/\+\-\?\:]*)((ht|f)tp(s|)\:\/\/|[\d\d\d|\d\d]\.[\d\d\d|\d\d]\.|www\.|\.tv|\.ac|\.com|\.edu|\.gov|\.int|\.mil|\.net|\.org|\.biz|\.info|\.name|\.pro|\.museum|\.co)([\d\w\.\/\%\+\-\=\&amp;\?\:\\\&quot;\'\,\|\~\;]*)\b/gi),result)return result[0]}(t),!L.hasOwnProperty(t)&&t&&("http://"==x(t,0,7)||"https://"==x(t,0,8)||"www."==x(t,0,4))){var o=S(t,"https://",0),a=S(t,"http://",0);if(0===o||0===a){var n=S(t,"youtube.com",0),r=S(t,"youtu.be",0),s=S(t,"vimeo.com",0);n||r||s?(e(".userTagging-userShareVideo").removeClass("hidden"),e(".userTagging-userShareLink").addClass("hidden"),e("#userShareLink").val(""),e("#userShareVideo").val(t),j("userShareVideo",t,!0,i)):(e(".userTagging-userShareLink").removeClass("hidden"),e(".userTagging-userShareVideo").addClass("hidden"),e("#userShareVideo").val(""),e("#userShareLink").val(t),j("userShareLink",t,!0,i))}}},x=function(e,t,i){return t<0&&(t+=e.length),void 0==i?i=e.length:i+=i<0?e.length:t,i<t&&(i=t),e.substring(t,i)},S=function(e,t,i){var o=(e+"").indexOf(t,i||0);return-1!==o&&o},A=function(){""!=e("#userShareLink").val().trim()&&(L[e("#userShareLink").val().trim()]="1"),""!=e("#userShareVideo").val().trim()&&(L[e("#userShareVideo").val().trim()]="1"),e("#preview_link").remove(),e("#userShareLink").val(""),e("#userShareVideo").val(""),e("#shareImage").val("1"),e("body").trigger("afterDestroyPreviewLinkWallCallback",[])},F=!1,M={},L={},j=function(t,i,o,a){var n=e(".userTagging-"+t);M.hasOwnProperty(i)||n.spin("tiny"),setTimeout(function(){if(!F){if(M.hasOwnProperty(i))return console.log(M[i]),F=!0,void B(n,i,o,a,M[i]);F=!0;var t=mooConfig.url.base+"/activities/ajax_preview_link";e.post(t,{content:i},function(e){M[i]=e,n.spin(!1),B(n,i,o,a,e)})}},0)},B=function(t,i,o,a,n){e("#preview_link").remove();var r=jQuery.parseJSON(n);if(!jQuery.isEmptyObject(r)&&void 0!==r.title&&"404 Not Found"!==r.title&&"403 Forbidden"!==r.title){var s='<div class="activity_item" id="preview_link">';void 0!==r.image&&""!=r.image&&(s+='<div class="activity_left"><a class="removePreviewlink removeImage" href="javascript:void(0)"><i class="icon-delete material-icons">clear</i></a>',-1!=r.image.indexOf("http")?s+='<img src="'+r.image+'" class="img_wrapper2">':s+='<img src="'+mooConfig.url.base+"/uploads/links/"+r.image+'" class="img_wrapper2">',s+='<input type="hidden" name="data[share_image]" id="userShareLink" value="1">',s+="</div>"),""!=r.image?s+='<div class="activity_right">':s+="<div>",s+='<a class="removePreviewlink removeContent" href="javascript:void(0)"><i class="icon-delete material-icons">clear</i></a>',s+='<a class="attachment_edit_link feed_title" href="'+r.url+'" target="_blank" rel="nofollow">',s+="<strong>"+r.title+"</strong>",s+="</a>",void 0!==r.description&&""!=r.description&&(s+='<div class="attachment_body_description">',s+='<a class="attachment_edit_link comment_message feed_detail_text">'+r.description+"</a>",s+="</div>"),s+='<input type="hidden" name="data[share_text]" id="userShareLink" value="1">',s+="</div></div>",t.append(s),o&&(e(".textoverlay").text(a),e(".autogrow-textarea-mirror").text(a)),e(".removeImage").unbind("click"),e(".removeImage").on("click",function(){e(this).parent().remove(),e("#shareImage").val("0")}),e(".removeContent").unbind("click"),e(".removeContent").on("click",function(){A()}),e("body").trigger("afterPreviewLinkWallCallback",[])}F=!1},T=function(){if(!r.validateUser())return!1;var i=e("#message").val();""!=e.trim(i)||e("#video_destination").length>0&&""!==e("#video_destination").val()||""!=e("#userShareLink").val()||""!=e("#userShareVideo").val()||""!=e("#wall_photo_preview :not(#addMoreImage)").html()&&"add"!=e("#wall_photo_preview :not(#addMoreImage)").html()?(s.disableButton("status_btn"),e("#status_btn").spin("small"),e.post(mooConfig.url.base+"/activities/ajax_share",e("#wallForm").serialize(),function(i){if(e("#wall_photo").val(""),s.enableButton("status_btn"),e("#message").val(""),e(".userTagging-userShareLink").addClass("hidden"),e(".userTagging-userShareVideo").addClass("hidden"),e("#shareImage").val("1"),e("#video_destination").length>0&&""!==e("#video_destination").val())e.fn.SimpleModal({model:"content",title:t.__("upload_video_phrase_4"),contents:t.__("upload_video_phrase_0")}).showModal(),setTimeout(function(){e("#simpleModal").hideModal()},3e3);else if(""!=i){e(".no-feed").length>0&&e("#list-content .no-feed").remove(),e("#list-content").prepend(i),e("#message").css("height","36px"),e(".slide").slideDown(),e("#wall_photo_preview span:not(.addMoreImage)").remove(),e("#addMoreImage").hide(),e(".form-feed-holder").css("padding-bottom","0px");var a=e(i).find("div[id^=comment_button_attach_]").data("id");m.registerAttachComment(a)}e("#status_btn").spin(!1),l.init(),e(".tip").tipsy({html:!0,gravity:"s"}),e('[data-toggle="tooltip"]').tooltip();var n=e("#wallForm").find("#message");o.resetMention(n),_.init(),e("#preview_link").remove(),L={},e("#userShareLink").val(""),e("#userShareVideo").val(""),e("body").trigger("afterPostWallCallbackSuccess",[])}),e(".stt-action .userTagging-userTagging").addClass("hidden"),e(".stt-action").css("margin-top","0"),e("#wall_photo_preview").hide(),e("#userTagging").tagsinput("removeAll")):e.fn.SimpleModal({btn_ok:t.__("btn_ok"),btn_cancel:t.__("cancel"),model:"modal",title:t.__("warning"),contents:t.__("share_whats_new_can_not_empty")}).showModal()};return{init:C,initActivityForm:function(){e('[data-toggle="tooltip"]').tooltip();new n.fineUploader({element:e("#select-2")[0],text:{uploadButton:'<div class="upload-section"><i class="material-icons">photo_camera</i></div>'},validation:{allowedExtensions:mooConfig.photoExt,sizeLimit:mooConfig.sizeLimit},multiple:!0,request:{endpoint:mooConfig.url.base+"/upload/wall"},callbacks:{onError:c.errorHandler,onSubmit:function(t,i){e('<span id="feed_'+t+'" style="background-image:url('+mooConfig.url.base+'/img/indicator.gif);background-size:inherit;background-repeat:no-repeat"></span>').insertBefore(".addMoreImage"),e("#wall_photo_preview").show(),e("#addMoreImage").show()},onComplete:function(t,i,o,a){if(o.success){e('[data-toggle="tooltip"]').tooltip("hide"),e(this.getItemByFileId(t)).remove(),e('<img src="'+o.file_path+'">').load(function(){var i=e("#feed_"+t);i.attr("style","background-image:url("+o.file_path+")");var a=e('<a href="#"><i class="material-icons thumb-review-delete">clear</i></a>');i.append(a),i.find(".thumb-review-delete").unbind("click"),i.find(".thumb-review-delete").click(function(t){t.preventDefault(),e(this).parents("span").remove(),e("#wall_photo").val(e("#wall_photo").val().replace(o.photo+",","")),e("body").trigger("afterDeleteWallPhotoCallback",[o])})});var n=e("#wall_photo").val();e("#wall_photo").val(n+o.photo+","),A()}e("body").trigger("afterUploadWallPhotoCallback",[o])}}});e("#addMoreImage").unbind("click"),e("#addMoreImage").click(function(){e("#select-2 input[name=file]").click()}),e("#message").on("focus",function(){d.showCommentButton(0)}),e("#status_btn").unbind("click"),e("#status_btn").click(function(){T()}),e("#status_box").slideDown("slow",function(){e("body").trigger("afterShowStatusBoxCallback")}),e("#message").on("paste",function(t){if(""==e("#wall_photo").val().trim()&&0==e("#preview_link").length&&t.originalEvent.clipboardData){var i=t.originalEvent.clipboardData.getData("text/plain");I(i)}}),e("#message").on("keydown keyup keypress",function(t){if(""==e("#wall_photo").val().trim()&&!t.ctrlKey&&0==e("#preview_link").length){var i=e(this).val();I(i)}})},initOnAjaxLoadActivityEdit:function(){e(".cancelEditActivity").unbind("click"),e(".cancelEditActivity").click(function(){var t=e(this).data();b(t.activityId)}),e(".confirmEditActivity").unbind("click"),e(".confirmEditActivity").click(function(){var t=e(this).data();w(t.activityId)})}}});