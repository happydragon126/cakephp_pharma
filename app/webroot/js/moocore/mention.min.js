(function(h,A){"function"===typeof define&&define.amd?define(["jquery","overlay","textcomplete","bloodhound"],A):"object"===typeof exports?module.exports=A(require("jquery")):h.mooMention=A()})(this,function(h){function A(a,e){var f=String(a.data.obj.value),d=h(a.data.mirrorCheckSpell).html();if(f!=d){a:{var c=f.split(/(\s+)/);for(var g=d.split(/(\s+)/),q=index=0;q<c.length;q++){if(c[q]!=g[q]){c={beforeChanged:g[q],afterChanged:c[q],index:index};break a}index+=g[q].length}c=void 0}f.split("");d.split("");
d=c.beforeChanged;g=c.afterChanged;if(void 0!=d&&void 0!=g){if(d.length<g.length&&(rangeSpell=g.length-d.length,0<Object.keys(b).length))for(var k in b)b.hasOwnProperty(k)&&b[k].start>c.index&&(b[k].start+=rangeSpell,b[k].end+=rangeSpell);if(d.length>g.length&&(rangeSpell=d.length-g.length,0<Object.keys(b).length))for(k in b)b.hasOwnProperty(k)&&b[k].start>c.index&&(b[k].start-=rangeSpell,b[k].end-=rangeSpell)}h(a.data.mirrorCheckSpell).html(f);k=a.data.mirror;d=[];f=f.split("");c="";if(0<Object.keys(b).length){g=
0;for(m in b)b.hasOwnProperty(m)&&(d[g]=b[m],d[g].key=m,g++);for(g=0;g<d.length-1;g++)for(j=g+1;j<d.length;j++)if(d[g].start>d[j].start){var m=d[j];d[j]=d[g];d[g]=m}}for(g=0;g<f.length;g++){m=!1;if(0<d.length)for(j=0;j<d.length;j++)g==d[j].start&&(c+="@["+d[j].key+":"+f[g],m=!0),g==d[j].end&&(c+="]"+f[g],m=!0);m||(c+=f[g])}for(j=0;j<d.length;j++)d[j].end==f.length&&(c+="]");k.value=c;w(h(a.data.obj))}}var F,G,B={},x=[],v,K,H,b={},C={},L={},M=!1,z=[];if(mooConfig.isMention)h("body").on("focus","textarea",
function(){var a=h(this).siblings("input.messageHidden");0<a.length&&(D(h(this)),N(a.val(),h(this)))});h("body").on("keydown",function(a){a.stopPropagation();if(116==a.which){var b=h("textarea");h.each(b,function(b,d){if(""!=h(d).val())return a.preventDefault(),window.confirm("This page is asking you to confirm that you want to leave - data you have entered may not be saved.")&&(h("textarea").val(""),h(".messageHidden").val(""),window.location.reload()),!1})}});var P=function(a,e){h("#"+e).destroyOverlayInstance(h("#"+
e));h("#"+e).textcomplete([{mentions:a,match:/\B@(.+)$/,search:function(a,b){K=a.length;b(h.map(this.mentions,function(b,f){if(-1!=x.indexOf(f))return null;a:{var c=a.toLowerCase();var d="\\()[]^{}*+?$.".split(""),e;for(e in d)if(d.hasOwnProperty(e)&&-1!=c.indexOf(d[e])){c=!0;break a}c=!1}if(c)return null;c=new RegExp("\\b"+a.toLowerCase(),"g");if(b)return b.toLowerCase().match(c)?f:null}))},template:function(a){return'<img src="'+L[a]+'" class="user_avatar_small" /> '+B[a]},index:1,replace:function(a){return B[a]}}],
{appendTo:"body",zIndex:1055}).overlay([{match:{},css:{"background-color":"#CAD8F4"}}]).on({"textComplete:select":function(a,d,c){a=B[d];for(var f in B)if(d==f){c=h(this).prop("selectionStart")-a.length+1;var e=void 0,k=c,m=void 0,n={};if(0<Object.keys(b).length)for(e in b)b.hasOwnProperty(e)&&k>=b[e].end&&(k+=replaceLength[e].length-b[e].length,m+=replaceLength[e].length-b[e].length);n.start=k;n.end=m;var p=n;e=void 0;n=f;k=a;m=h(this);p=p.start;var r=K,t=m.siblings(".messageHidden"),u=t.val(),y=
"["+n+":"+k+"]",l=u.substring(0,p),v=u.substring(p);v=v.replace(u.substring(p,p+r),y);t.val(l+v);m.siblings(".checkSpell").html(m.val());replaceLength[n]={start:p-1,end:p+y.length,length:y.length+1};n=y.length+1;if(0<Object.keys(b).length)for(e in b)b.hasOwnProperty(e)&&p-1<=b[e].start&&(replaceLength[e].start=replaceLength[e].start-(r+1)+n,replaceLength[e].end=replaceLength[e].end-(r+1)+n,b[e].start=b[e].start-(r+1)+k.length,b[e].end=b[e].end-(r+1)+k.length);w(m);x.push(f);--c;b[f]={start:c,end:h(this).prop("selectionStart"),
length:h(this).prop("selectionStart")-c};w(h(this),!0)}}});0==h("#"+e).siblings("input.messageHidden").length&&("edit_activity"==H?h("#"+e).after('<input type="hidden" id="'+e+'_hidden" name="data[message]" class="messageHidden" /><div class="checkSpell" style="display: none"></div>'):h("#"+e).after('<input type="hidden" name="data[message]" class="messageHidden" /><div class="checkSpell" style="display: none"></div>'));v=h("#"+e).siblings(".messageHidden")[0];mirrorCheckSpell=jQuery("#"+e).siblings(".checkSpell")[0];
"edit_activity"==H&&(v.value=G);h("#"+e).on("keypress keydown",{obj:jQuery("#"+e)[0],mirror:v,mirrorCheckSpell:mirrorCheckSpell},O);h("#"+e).bind("input",{obj:jQuery("#"+e)[0],mirror:v,mirrorCheckSpell:mirrorCheckSpell},A);h("#"+e).on("paste",{obj:jQuery("#"+e)[0],mirror:v,mirrorCheckSpell:mirrorCheckSpell},V);h("#"+e).on("cut",{obj:jQuery("#"+e)[0],mirror:v,mirrorCheckSpell:mirrorCheckSpell},W)},N=function(a,e){var f=0,d=0;D(e);var c=a.replace(/@\[(\d+):([^\]]+)\]/g,function(c,e,h){x.push(e);replaceLength[e]=
{start:a.indexOf(c),end:a.indexOf(c)+c.length,length:c.length};var g=a.indexOf(c)-f+d;b[e]={start:g,end:g+h.length,length:h.length};f+=c.length;d+=h.length;return h});e.val(c);w(e)},O=function(a,e){if(X(a)||"undefined"!=typeof e){var f=h(a.data.obj).prop("selectionStart"),d=f,c=h(a.data.obj).prop("selectionEnd"),g=c,q=String(a.data.mirror.value),k=String(a.data.obj.value),m=!1,n=0;if("keypress"!=a.type||!a.metaKey||99!=a.which){if(0<Object.keys(b).length){var p=!1;for(l in b){if(p&&!m)break;if(b.hasOwnProperty(l)){if(d>=
b[l].end)f=u(d),c=u(d,g),d==b[l].end&&"keydown"==a.type&&8==a.which&&d==g&&(a.preventDefault(),d=Q(d-1,k,l),n=g-d,E(a,k,d,g),c=R(l,f,c,d,g),f=c.selectionStart,c=c.selectionEnd,p=!0);else{if(g>b[l].start&&d<b[l].start||g>b[l].end&&d<b[l].end){c=String(a.data.obj.value);f=u(d);q=S(f,c,q,d);f=c.substring(g);m=13==a.which?"\\n":32==a.which?" ":"keydown"!=a.type||46!=a.which&&8!=a.which?"undefined"==typeof e||"cut"!=a.type&&"delete"!=a.type?String.fromCharCode(a.which):"":"";a.data.mirror.value=q+m+f;
I(l,d);jQuery(a.data.mirrorCheckSpell).html(k.substring(0,d)+m+k.substring(g));w(h(a.data.obj));return}if(d==b[l].start||d==b[l].start&&g==b[l].end){if(d!=g||d==g&&"keydown"==a.type&&46==a.which)a.preventDefault(),p=0,d!=g&&8==a.which?p=1:46==a.which&&(p=1),u(d),u(d,g),g=T(d,k,l),c=g<b[l].end?1:0,g==b[l].end&&a.preventDefault(),p=g<b[l].end?p:0,n=g-d,f=replaceLength[l].end-b[l].length-1,c=f+n+c,g+=p,E(a,k,d,g),U(f,c,l),p=!0}else if(b[l].start<d&&b[l].end>d){if("keydown"==a.type&&46==a.which||8==a.which)a.preventDefault(),
f=u(d),c=u(d,g),d==g&&(8==a.which&&d>b[l].start?(g--,d--):46==a.which&&g<b[l].end&&(g++,d++),d>b[l].start&&d--),d=Q(d,k,l),g=T(g,k,l),g+=g<b[l].end&&d==b[l].start?1:0,n=g-d,E(a,k,d,g),c=R(l,f,c,d,g),f=c.selectionStart,c=c.selectionEnd;else{c=String(a.data.obj.value);q=q.substring(0,replaceLength[l].start);q+=c.substring(b[l].start,d);f=c.substring(g);m=13==a.which?"\\n":32==a.which?" ":"keydown"==a.type&&46==a.which||8==a.which?"":"undefined"==typeof e||"cut"!=a.type&&"delete"!=a.type?String.fromCharCode(a.which):
"";a.data.mirror.value=q+m+f;I(l,d);jQuery(a.data.mirrorCheckSpell).html(k.substring(0,d)+m+k.substring(g));w(h(a.data.obj));return}p=!0}}if(0==b[l].length){f=replaceLength[l].start;c=replaceLength[l].end+n;for(var r in x)x[r]==l&&x.splice(r,1);delete replaceLength[l];delete b[l];J(f,c,a,y);E(a,k,d,g);w(h(a.data.obj));var t=f;var v=c;var y=n;m=!0;break}}}}m||("undefined"!=typeof t&&"undefined"!=typeof y?J(t,v,a,y):J(d,g,a));13==a.which?m="\n":32==a.which?m=" ":"keydown"!=a.type||46!=a.which&&8!=a.which?
m="undefined"==typeof e||"cut"!=a.type&&"delete"!=a.type?"keypress"!=a.type||!a.metaKey||118!=a.which&&120!=a.which&&99!=a.which&&97!=a.which?String.fromCharCode(a.which):"":"":(m="",f==c&&(8==a.which?--f:46==a.which&&(c+=1)),d==g&&(8==a.which?--d:46==a.which&&(g+=1)));var l=q.substring(0,f);q=q.substring(c);a.data.mirror.value=l+m+q;jQuery(a.data.mirrorCheckSpell).html(k.substring(0,d)+m+k.substring(g));w(h(a.data.obj))}}},V=function(a){var e=h(a.data.obj).prop("selectionStart"),f=e,d=h(a.data.obj).prop("selectionEnd"),
c=d,g="",q,k=String(a.data.mirror.value),m=String(a.data.obj.value);setTimeout(function(){var n=String(a.data.obj.value),p=h(a.data.obj).prop("selectionStart");h(a.data.obj).prop("selectionEnd");q=p-f-(c-f);g=n.substring(f,p);if(0<Object.keys(b).length)for(var r in b)if(b.hasOwnProperty(r))if(f==c&&(f<=b[r].start||c>=b[r].end))e=u(f),d=u(f,c);else{e=u(f);var t=S(e,n,k,f);n=n.substring(p);a.data.mirror.value=t+g+n;I(r,f);jQuery(a.data.mirrorCheckSpell).html(m.substring(0,f)+g+m.substring(c));return}r=
q;if(0<Object.keys(b).length)for(t in b)b.hasOwnProperty(t)&&f<=b[t].start&&(replaceLength[t].start+=r,replaceLength[t].end+=r,b[t].start+=r,b[t].end+=r);r=k.substring(0,e);n=k.substring(d,k.length);k=r+g+n;a.data.mirror.value=k;jQuery(a.data.mirrorCheckSpell).html(m.substring(0,f)+g+m.substring(c))},10)},W=function(a){O(a,!0)},Y=function(a){var b=a.data.obj,f=a.data.mirror;setTimeout(function(){f.value=String(b.value);D(h(b))},10)},U=function(a,e,f){0<Object.keys(b).length&&(a=0==e-a?1:e-a,replaceLength[f].end-=
a,replaceLength[f].length-=a,b[f].end-=a,b[f].length-=a)},X=function(a){var e=a.which;if("keypress"==a.type&&8!=e)return 0!=e?a.ctrlKey?(!a.ctrlKey||90!=e&&89!=e||Y(a),!1):"none"!=h('ul[id^="textcomplete-dropdown"]').css("display")&&13==e?!1:!0:!1;if("keydown"==a.type){if(46==e||8==e)return!0;if(116==e)0<Object.keys(b).length&&(a.preventDefault(),a.stopPropagation(),window.confirm("This page is asking you to confirm that you want to leave - data you have entered may not be saved.")&&(h("textarea").val(""),
h(".messageHidden").val(""),window.location.reload()));else return!1}},J=function(a,e,f,d){if(0<Object.keys(b).length)for(var c in b)b.hasOwnProperty(c)&&(a<b[c].start&&(8!=f.which||0!=a||0!=e)?"keydown"==f.type&&(46==f.which||8==f.which)||"cut"==f.type?(replaceLength[c].start-=e==a?1:e-a,replaceLength[c].end-=e==a?1:e-a,"undefined"==typeof d||0==d?(b[c].start-=e==a?1:e-a,b[c].end-=e==a?1:e-a):(b[c].start-=d,b[c].end-=d)):(replaceLength[c].start=replaceLength[c].start-(e-a)+1,replaceLength[c].end=
replaceLength[c].end-(e-a)+1,"undefined"==typeof d||0==d?(b[c].start=b[c].start-(e-a)+1,b[c].end=b[c].end-(e-a)+1):(b[c].start=b[c].start-d+1,b[c].end=b[c].end-d+1)):a==b[c].start&&("keydown"!=f.type||46!=f.which&&8!=f.which)?(replaceLength[c].start=replaceLength[c].start-(e-a)+1,replaceLength[c].end=replaceLength[c].end-(e-a)+1,"undefined"==typeof d||0==d?(b[c].start=b[c].start-(e-a)+1,b[c].end=b[c].end-(e-a)+1):(b[c].start=b[c].start-d+1,b[c].end=b[c].end-d+1)):a==b[c].start&&8==f.which&&0<replaceLength[c].start&&
0<b[c].start&&a==e!=0&&(replaceLength[c].start--,replaceLength[c].end--,b[c].start--,b[c].end--))},I=function(a,e){for(var f in b)b.hasOwnProperty(f)&&"undefined"!=typeof e&&b[f].start<=e&&b[f].end>e&&(a=f);var d=b[a].start,c={},g={},h=[];for(f in b)b.hasOwnProperty(f)&&b[f].start<d&&(c[f]=b[f],g[f]=replaceLength[f],h.push(f));b=c;replaceLength=g;x=h},u=function(a,e){var f=a,d=e,c;for(c in b)b.hasOwnProperty(c)&&b[c].end<=a&&("undefined"==typeof e?f+=replaceLength[c].length-b[c].length:d+=replaceLength[c].length-
b[c].length);return"undefined"==typeof e?f:d},S=function(a,e,f,d){var c="",g;for(g in b)b.hasOwnProperty(g)&&a>replaceLength[g].start&&a<replaceLength[g].end&&(a=replaceLength[g].start,c=e.substring(b[g].start,d));return f.substring(0,a)+c},D=function(a){b={};replaceLength={};x=[];w(a)},w=function(a,e){F=a.getInstanceOverlay(a);a.revokeOverlay([{match:b}],F);a.reRenderTextOnOverlay(F)},Q=function(a,e,f){for(var d=e.substr(a,1);" "!=d&&a>b[f].start;d=e.substr(a,1))a--;return a},T=function(a,e,f){for(var d=
e.substr(a,1);" "!=d&&a<b[f].end;d=e.substr(a,1))a++;return a},R=function(a,e,f,d,c){e=u(d);f=u(d,c);f-=replaceLength[a].start;e-=replaceLength[a].start;f=b[a].length-f;e=b[a].length-e;e=replaceLength[a].end-e-1;f=replaceLength[a].end-f-1;U(e,f,a);return{selectionStart:e,selectionEnd:f}},E=function(a,b,f,d){var c=b.substring(0,f);b=b.substring(d);a.data.obj.value=c+b;a=a.data.obj;a.setSelectionRange?(a.focus(),a.setSelectionRange(f,f)):a.createTextRange&&(a=a.createTextRange(),a.collapse(!0),a.moveEnd("character",
f),a.moveStart("character",f),a.select())};return{init:function(a,b){if(mooConfig.isMention){H=b;switch(b){case "edit_activity":G=h("#"+a).val(),N(G,h("#"+a))}-1==h.inArray(a,z)&&(0==Object.keys(C).length?M?z.push(a):(M=!0,z.push(a),(new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.name)},queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:{url:mooConfig.url.base+"/users/friends.json",cache:!1,filter:function(a){h.each(a.data,function(a,b){C[b.id]=b.name;B[b.id]=
b.name;L[b.id]=b.avatar});for(i=0;i<z.length;i++)P(C,z[i]);z=[];return h.map(a.data,function(a){return a})}},identify:function(a){return a.id}})).initialize()):P(C,a))}},resetMention:function(a){a.siblings("input.messageHidden").val("");a.siblings("div.textoverlay").html("");D(a)},reConfigOverlay:w}});